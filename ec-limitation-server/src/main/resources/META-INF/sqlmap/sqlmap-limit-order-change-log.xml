<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.weimob.saas.ec.limitation.dao.LimitOrderChangeLogDao">

  <resultMap id="BaseResultMap" type="com.weimob.saas.ec.limitation.entity.LimitOrderChangeLogEntity">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="pid" jdbcType="BIGINT" property="pid" />
    <result column="store_id" jdbcType="BIGINT" property="storeId" />
    <result column="wid" jdbcType="BIGINT" property="wid" />
    <result column="biz_id" jdbcType="BIGINT" property="bizId" />
    <result column="biz_type" jdbcType="TINYINT" property="bizType" />
    <result column="limit_id" jdbcType="BIGINT" property="limitId" />
    <result column="goods_id" jdbcType="BIGINT" property="goodsId" />
    <result column="sku_id" jdbcType="BIGINT" property="skuId" />
    <result column="buy_num" jdbcType="INTEGER" property="buyNum" />
    <result column="ticket" jdbcType="VARCHAR" property="ticket" />
    <result column="service_name" jdbcType="VARCHAR" property="serviceName" />
    <result column="content" jdbcType="VARCHAR" property="content" />
    <result column="refer_id" jdbcType="CHAR" property="referId" />
    <result column="status" jdbcType="BIT" property="status" />
    <result column="is_deleted" jdbcType="BIT" property="isDeleted" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="limit_level" jdbcType="TINYINT" property="limitLevel"/>
    <result column="is_original" jdbcType="TINYINT" property="isOriginal"/>
  </resultMap>

  <sql id="Base_Column_List">
    id,
    pid,
    store_id,
    wid,
    biz_id,
    biz_type,
    limit_id,
    goods_id,
    sku_id,
    buy_num,
    ticket,
    service_name,
    content,
    refer_id,
    status,
    is_deleted,
    create_time,
    update_time,
    limit_level,
    is_original
  </sql>

  <insert id="insertLog" parameterType="LimitOrderChangeLogEntity">
    INSERT intolimit_order_change_log (
      pid,
      store_id,
      wid,
      biz_id,
      biz_type,
      limit_id,
      goods_id,
      sku_id,
      buy_num,
      ticket,
      service_name,
      content,
      refer_id,
      status,
      is_deleted,
      create_time,
      update_time,
      limit_level,
      is_original
      )
    VALUES
      (
      #{pid},
      #{storeId},
      #{wid},
      #{bizId},
      #{bizType},
      #{limitId},
      #{goodsId},
      #{skuId},
      #{buyNum},
      #{ticket},
      #{serviceName},
      #{content},
      #{referId},
      #{status},
      0,
      NOW(),
      NOW(),
      #{limitLevel},
      #{isOriginal}
      )
  /*LimitOrderChangeLogDao.insertLog*/
  </insert>

  <update id="updateLogStatusByTicket" parameterType="java.lang.String">
    UPDATE
      limit_order_change_log
    SET
      status = 1,
      update_time = NOW()
    WHERE
      ticket = #{ticket}
    AND is_deleted = 0
  /*LimitOrderChangeLogDao.updateLogStatusByTicket*/
  </update>

  <select id="getLogByReferId" parameterType="LimitOrderChangeLogEntity" resultMap="BaseResultMap">
    SELECT
      <include refid="Base_Column_List" />
    FROM
      limit_order_change_log
    WHERE
      refer_id = #{referId}
    AND biz_type = #{bizType}
    AND service_name = 'DEDUCT_USER_LIMIT'
  /*LimitOrderChangeLogDao.getLogByReferId*/
  </select>

  <select id="listLogByTicket" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT
      <include refid="Base_Column_List" />
    FROM
      limit_order_change_log
    WHERE
      ticket = #{ticket}
    AND status = 0
  /*LimitOrderChangeLogDao.listLogByTicket*/
  </select>

</mapper>