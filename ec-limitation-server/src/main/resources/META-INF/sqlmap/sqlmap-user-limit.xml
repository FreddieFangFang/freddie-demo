<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.weimob.saas.ec.limitation.dao.UserLimitDao">

  <resultMap id="BaseResultMap" type="com.weimob.saas.ec.limitation.entity.UserLimitEntity">
    <id column="id" jdbcType="BIGINT" property="id"/>
    <result column="pid" jdbcType="BIGINT" property="pid"/>
    <result column="store_id" jdbcType="BIGINT" property="storeId"/>
    <result column="wid" jdbcType="BIGINT" property="wid"/>
    <result column="limit_id" jdbcType="BIGINT" property="limitId"/>
    <result column="biz_id" jdbcType="BIGINT" property="bizId"/>
    <result column="biz_type" jdbcType="TINYINT" property="bizType"/>
    <result column="buy_num" jdbcType="INTEGER" property="buyNum"/>
    <result column="is_deleted" jdbcType="BIT" property="isDeleted"/>
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
  </resultMap>

  <sql id="Base_Column_List">
    id,
    pid,
    store_id,
    wid,
    biz_id,
    biz_type,
    limit_id,
    buy_num,
    is_deleted,
    create_time,
    update_time
  </sql>

  <insert id="insertUserLimit" parameterType="UserLimitEntity">
    INSERT INTO user_limit (
      pid,
      store_id,
      wid,
      limit_id,
      biz_id,
      biz_type,
      buy_num,
      is_deleted,
      create_time,
      update_time
      )
    VALUES
      (
        #{pid},
        #{storeId},
        #{wid},
        #{limitId},
        #{bizId},
        #{bizType},
        #{buyNum},
        0,
        NOW(),
        NOW()
      )
  /*UserLimitDao.insertUserLimit*/
  </insert>

  <update id="deleteDiscountUserLimit" parameterType="DeleteDiscountUserLimitInfoRequestVo">
    UPDATE
      user_limit
    SET
      wid =-1 * wid,
      update_time = NOW()
    WHERE
      pid = #{pid}
    AND biz_id = #{bizId}
    AND biz_type = #{bizType}
    AND is_deleted = 0
    AND wid > 0
  /*UserLimitDao.deleteDiscountUserLimit*/
  </update>

  <update id="updateUserLimit" parameterType="UserLimitEntity">
    UPDATE
      user_limit
    SET
      buy_num = buy_num + #{buyNum},
      update_time = NOW()
    WHERE
      pid = #{pid}
    AND store_id = #{storeId}
    AND wid = #{wid}
    AND limit_id = #{limitId}
  /*UserLimitDao.updateUserLimit*/
  </update>

  <update id="deductUserLimit" parameterType="UserLimitEntity">
    UPDATE
      user_limit
    SET
      buy_num = buy_num - #{buyNum},
      update_time = NOW()
    WHERE
      pid = #{pid}
    AND store_id = #{storeId}
    AND wid = #{wid}
    AND limit_id = #{limitId}
    AND buy_num >= #{buyNum}
  /*UserLimitDao.deductUserLimit*/
  </update>

  <select id="getUserLimit" parameterType="UserLimitEntity" resultType="UserLimitEntity">
    SELECT
      <include refid="Base_Column_List"/>
    FROM
      user_limit
    WHERE
      pid = #{pid}
    AND store_id = #{storeId}
    AND wid = #{wid}
    AND limit_id = #{limitId}
    AND is_deleted = 0
  /*UserLimitDao.getUserLimit*/
  </select>

  <select id="listUserLimitByBizId" resultMap="BaseResultMap" parameterType="java.util.List">
    SELECT
      userlimit.pid pid,
      userlimit.store_id store_id,
      userlimit.limit_id limit_id,
      userlimit.biz_id biz_id,
      userlimit.biz_type biz_type,
      userlimit.buy_num buy_num
    FROM
      user_limit AS userlimit,
      limit_info AS limitinfo
    WHERE
      limitinfo.limit_id=userlimit.limit_id
    AND (
      <foreach item="item" index="index" collection="list" separator="or">
        userlimit.pid = #{item.pid}
        AND userlimit.store_id = #{item.storeId}
        AND userlimit.wid =#{item.wid}
        AND userlimit.biz_id =#{item.bizId}
        AND userlimit.biz_type=#{item.bizType}
        AND userlimit.is_deleted = 0
        AND limitinfo.is_deleted = 0
      </foreach>
    )
  /*UserLimitDao.listUserLimitByBizId*/
  </select>

  <select id="listUserLimitByLimitId" parameterType="java.util.List" resultMap="BaseResultMap">
    SELECT
      <include refid="Base_Column_List"/>
    FROM
      user_limit
    WHERE
      <foreach item="item" index="index" collection="list" separator="or">
        pid = #{item.pid}
        AND wid = #{item.wid}
        AND limit_id = #{item.limitId}
        AND is_deleted = 0
      </foreach>
  /*UserLimitDao.listUserLimitByLimitId*/
  </select>

  <select id="listUserLimitByLimitIdList" parameterType="com.weimob.saas.ec.limitation.model.CommonLimitParam" resultMap="BaseResultMap">
    SELECT
      <include refid="Base_Column_List"/>
    FROM
      user_limit
    WHERE
    pid = #{pid}
    AND wid = #{wid}
    AND is_deleted = 0
    AND limit_id IN
    <foreach item="id" index="index" collection="limitIdList" open="(" separator="," close=")">
      #{id}
    </foreach>
  /*UserLimitDao.listUserLimitByLimitIdList*/
  </select>

</mapper>

